# Squid proxy configuration for Replicante network filtering
# This provides HTTP/HTTPS filtering at the proxy level

# Basic settings
http_port 3128
visible_hostname replicante-proxy
hostname_visible off
forwarded_for delete

# Access logging
access_log /var/log/squid/access.log squid
cache_log /var/log/squid/cache.log
cache_store_log none

# Disable caching (we only want filtering)
cache deny all
cache_dir null /tmp

# DNS configuration
dns_nameservers 172.20.0.3
dns_v4_first on

# Define allowed domains (whitelist)
acl allowed_domains dstdomain "/etc/squid/whitelist.txt"

# Define allowed ports
acl SSL_ports port 443
acl Safe_ports port 80          # http
acl Safe_ports port 443         # https
acl CONNECT method CONNECT

# Local network ACL
acl localnet src 172.20.0.0/16  # Docker network

# Deny requests to non-safe ports
http_access deny !Safe_ports

# Deny CONNECT to non-SSL ports
http_access deny CONNECT !SSL_ports

# Allow localhost
http_access allow localhost

# Allow local network to access allowed domains only
http_access allow localnet allowed_domains

# Log and deny everything else
http_access deny all

# Security headers
reply_header_access Server deny all
reply_header_access X-Squid-Error deny all
reply_header_access X-Cache deny all
reply_header_access X-Cache-Lookup deny all
reply_header_access Via deny all
reply_header_access X-Forwarded-For deny all

# Error page customization
error_directory /usr/share/squid/errors/en

# Performance tuning
max_filedesc 4096
shutdown_lifetime 3 seconds

# Security settings
httpd_suppress_version_string on
uri_whitespace strip

# Request size limits
request_body_max_size 10 MB
request_header_max_size 64 KB

# Connection limits
client_lifetime 1 hour
pconn_timeout 30 seconds

# Memory settings
cache_mem 8 MB
maximum_object_size_in_memory 512 KB

# Disable ICP
icp_port 0

# Disable HTCP
htcp_port 0

# HTTPS/SSL bump configuration (for inspecting HTTPS)
# Note: This requires SSL certificates to be configured
# Uncomment below to enable SSL inspection

# http_port 3129 ssl-bump \
#   cert=/etc/squid/ssl/squid.pem \
#   generate-host-certificates=on \
#   dynamic_cert_mem_cache_size=4MB

# acl step1 at_step SslBump1
# ssl_bump peek step1
# ssl_bump splice allowed_domains
# ssl_bump terminate all

# sslcrtd_program /usr/lib/squid/security_file_certgen -s /var/cache/squid/ssl_db -M 4MB
# sslproxy_cert_error allow all